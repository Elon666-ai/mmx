<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Debug Simulcast Player</title>
<style>
    body { background: #111; color: white; font-family: monospace; display: flex; flex-direction: column; height: 100vh; margin: 0; }
    #video-container { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; background: #000; }
    video { max-width: 100%; max-height: 100%; }
    #status { padding: 10px; background: #333; height: 100px; overflow-y: auto; border-top: 1px solid #555; }
    .log-line { margin: 2px 0; border-bottom: 1px solid #444; }
    .error { color: #ff5555; }
    .success { color: #55ff55; }
</style>
<script src="./reader.js"></script>
</head>
<body>

<div id="video-container">
    <video id="video" autoplay playsinline muted controls></video>
</div>
<div id="status">Waiting for connection...</div>

<script>
    const statusDiv = document.getElementById('status');
    const video = document.getElementById('video');
    
    function log(msg, type='') {
        const div = document.createElement('div');
        div.className = 'log-line ' + type;
        div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        statusDiv.prepend(div);
        console.log(msg);
    }

    window.addEventListener('load', () => {
        // 1. 严格的 URL 处理
        let baseUrl = window.location.href;
        
        // 移除 URL 中的 query parameters (?bitrate=...) 防止干扰
        baseUrl = baseUrl.split('?')[0];

        // 确保 URL 以 '/' 结尾
        if (!baseUrl.endsWith('/')) {
            baseUrl += '/';
        }

        // 拼接 whep
        const whepUrl = baseUrl + 'whep';
        
        log(`Base URL: ${baseUrl}`);
        log(`Target WHEP URL: ${whepUrl}`, 'success');

        const reader = new MediaMTXWebRTCReader({
            url: whepUrl,
            onError: (err) => {
                log(`ERROR: ${err}`, 'error');
            },
            onTrack: (evt) => {
                log(`Received Track: ${evt.track.kind}`, 'success');
                // 确保 Video 元素接收到流
                if (video.srcObject !== evt.streams[0]) {
                    video.srcObject = evt.streams[0];
                    log("Stream assigned to video element.");
                }
                
                // 强制尝试播放
                video.play().catch(e => log(`Autoplay warning: ${e.message}`, 'error'));
            }
        });

        window.reader = reader; // expose for debug
    });
</script>

</body>
</html>